---
title: "10_glmnet_siq_loocv_nonbrain"
author: "Jackie"
date: "11/25/2020"
output:
  word_document: default
  html_notebook: default
  html_document:
    df_print: paged
---

```{r, message=FALSE}
library(glmnet)
library(glmpath)
library(lars)
library(tidyverse)
library(dynutils)
library(readxl)
library(haven)
library(naniar)
library(pscl)
library(MASS)
library(stringr)
library(sjPlot)
library(directlabels)
library(caret)

set.seed(1234)
```

```{r, message=FALSE}
graph_net_fp <- "~/Box/Mooddata_Coordinating/1_Lab_Coordinating/Users/JackieSchwartz/PHIND_RS_and_Suicide/Octo2020Analysis/siq_graph.csv"

graph_net <- read_csv(graph_net_fp)
```

```{r}
options(scipen=999) 
z_score <- function(x) {
diff_mu <- x - mean(x, na.rm = T)
sd <- sd(x, na.rm = T)
diff_mu / sd
}
```

## de-selecting variables
```{r}
nonbrain_select <- graph_net %>%
  dplyr::select(-c(siq_total.T3, 
                   T3_YSR_New_Internalizing_Problems_Total_Score,
                   ends_with(".eff_loc"), 
                   ends_with(".deg"),
                   ends_with(".eig_cent"),
                   ends_with(".pc"),
                   ends_with(".wm_z")
                   )
                )
```

#### recoding and standardizing
```{r}

nonbrain_stand <- nonbrain_select %>%
  # converting race/ethinicity to factor and binarizing for analysis
  mutate(
    KSADS_Child_Race_by_P.T1 = factor(KSADS_Child_Race_by_P.T1),
    KSADS_Child_Race_by_P.T1_bin = ifelse(KSADS_Child_Race_by_P.T1 == "1", "1", "0"),
    # converting sex to factor
    sex_child = factor(sex_child),
    KSADS_Child_Race_by_P.T1_bin = factor(KSADS_Child_Race_by_P.T1_bin),
    meds_baseline = factor(meds_baseline)
    ) %>%
  # removing orig variable
  dplyr::select(-KSADS_Child_Race_by_P.T1) %>%
  # z-scoring siq
  mutate(siq_total_log_z = z_score(siq_total_log)) %>%
  # z-scoring all numeric variables
  mutate_at(vars(-ELS_ID, -siq_total_log, -KSADS_Child_Race_by_P.T1_bin, -sex_child, -T1_KSADS_C_or_P_Thoughts, -T1_KSADS_C_or_P_bx, -meds_baseline), z_score) %>%
  # arranging with ELS_ID first, then siq, then everything else
  dplyr::select(ELS_ID, siq_total_log_z, siq_total_log, everything())


nonbrain_stand_fp <- "~/Box/Mooddata_Coordinating/1_Lab_Coordinating/Users/JackieSchwartz/PHIND_RS_and_Suicide/Octo2020Analysis/siq_nonbrain_stand.csv"

nonbrain_forloocv <- write_csv(nonbrain_stand, nonbrain_stand_fp)
```


```{r}
nonbrain_stand_filt <- 
  nonbrain_stand %>%
  # removing race/ethnicity to look at separately and the temporal follow-up variables
  dplyr::select(-Age_S1.T3, -Tanner_Average.T3) %>%
  dplyr::select(ELS_ID, siq_total_log_z, everything())

# previous STBs already filtered

```

```{r}
nonbrain_stand_filt_siq <- nonbrain_stand_filt %>%
  dplyr::select(-ELS_ID,-siq_total_log, -meds_baseline, -T1_KSADS_C_or_P_Thoughts, -T1_KSADS_C_or_P_bx) %>%
  dplyr::select(siq_total_log_z, everything()) # response (dv) variable in first column

#as.matrix
supp_predictors_scaled <- data.matrix(nonbrain_stand_filt_siq[2:12]) # columns 2 - 11 are predictors
supp_siq_scaled <-nonbrain_stand_filt_siq$siq_total_log_z # my response variable
```

## to get sense of coefficient path
```{r}
supp_lasso <- glmnet(supp_predictors_scaled, supp_siq_scaled, family = "gaussian", alpha = 1)

plot(supp_lasso, xvar = "dev", label = TRUE)
```

okkayy so seems like 80/20 split on such a small sample is not wise. After speaking with Trevor H. suggested LOOCV, which actually minimizes simulation error and bias (avoiding randomness in the fold), and you're predicting the observation that wasn't used to fit the model.

### setting up folds
```{r}
set.seed(1234)
# We will use LOOCV to avoid randomness in folds

k <- nonbrain_stand_filt_siq %>% nrow() # k is equal to num of obs
k
```


```{r}
# conducting cross validated glmnet on whole sample using LOOCV
cv_model_loocv <- cv.glmnet(x = supp_predictors_scaled,
                            y = supp_siq_scaled,
                            family = "gaussian",
                            grouped = FALSE,
                            nfolds = k)

# computing RSquared value
# supp_predictors_scaled is my x matrix
# supp_siq_scaled is my y
X <- model.matrix(siq_total_log_z ~ ., data = nonbrain_stand_filt_siq)[,-1]
# model.matrix(siq_total_log_z ~ ., data = supp_graph_net_stand_siq)[,-1]
# predict
y_hat <- predict(cv_model_loocv,  newx = X,  s = "lambda.min")
# R-Squared
r_sq <- 1 - (sum((supp_siq_scaled - y_hat)^2) / sum((supp_siq_scaled - mean(supp_siq_scaled))^2))
r_sq


## extracting coefficients
cv_model_loocv$lambda.min # 0.07349182

coef_loocv <- coef(cv_model_loocv, s = "lambda.min")
```
#### diff between brain + nonbrain and just nonbrain
```{r}
0.2286668 - 0.2059464
# 0.0227204
```
